\documentclass[a4paper, 11pt]{article}

%Math
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{ulem}
\usepackage{stmaryrd} %f\UTF{00FC}r Blitz!

%PageStyle
\usepackage[ngerman]{babel} % deutsche Silbentrennung
\usepackage[ansinew]{inputenc} % wegen deutschen Umlauten
\usepackage{fontenc}
\usepackage{fancyhdr, graphicx} %for header/footer
\usepackage{wasysym}
\usepackage{fullpage}
\usepackage{textcomp}

% Listings
\usepackage{color}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{caption}

% Code listenings
\DeclareCaptionFont{white}{\color{white}}
\DeclareCaptionFormat{listing}{\colorbox{gray}{\parbox{\textwidth}{#1#2#3}}}
\captionsetup[lstlisting]{format=listing,labelfont=white,textfont=white}
 
\lstdefinestyle{JavaStyle}{
 language=Java,
 basicstyle=\footnotesize\ttfamily, % Standardschrift
 numbers=left,               % Ort der Zeilennummern
 numberstyle=\tiny,          % Stil der Zeilennummern
 stepnumber=5,              % Abstand zwischen den Zeilennummern
 numbersep=5pt,              % Abstand der Nummern zum Text
 tabsize=2,                  % Groesse von Tabs
 extendedchars=true,         %
 breaklines=true,            % Zeilen werden Umgebrochen
 frame=b,         
 %commentstyle=\itshape\color{LightLime}, Was isch das? O_o
 %keywordstyle=\bfseries\color{DarkPurple}, und das O_o
 basicstyle=\footnotesize\ttfamily,
 stringstyle=\color[RGB]{42,0,255}\ttfamily, % Farbe der String
 keywordstyle=\color[RGB]{127,0,85}\ttfamily, % Farbe der Keywords
 commentstyle=\color[RGB]{63,127,95}\ttfamily, % Farbe des Kommentars
 showspaces=false,           % Leerzeichen anzeigen ?
 showtabs=false,             % Tabs anzeigen ?
 xleftmargin=17pt,
 framexleftmargin=17pt,
 framexrightmargin=5pt,
 framexbottommargin=4pt,
 showstringspaces=false      % Leerzeichen in Strings anzeigen ?        
}

%Config
\renewcommand{\headrulewidth}{0pt}
\setlength{\headheight}{15.2pt}
\pagestyle{plain}

%Metadata
\title{Systemprogrammierung}
\author{Jan Fässler}
\date{3. Semester (HS 2012)}
\fancyfoot[C]{If you use this documentation for a exam, you should offer a beer to the authors!}

% hier beginnt das Dokument
\begin{document}

% Titelbild
\maketitle
\thispagestyle{fancy}

\newpage

% Inhaltsverzeichnis
\pagenumbering{Roman}
\tableofcontents	  	


\newpage
\setcounter{page}{1}
\pagenumbering{arabic}

% Inhalt Start

\section{Unix/Linux}

\subsection{Aufbau}
\begin{center}
	\includegraphics[scale=0.3]{aufbau-unix.png}
\end{center}

\subsection{Prozesse}
\subsubsection{Steuerungssystem}
\begin{itemize}
	\item Prozesse kreieren \& starten
	\item Prozesse schedulen, Warteschlangen, Ressourcenverbrauch
	\item Prozesse stoppen / unterbrechen / terminieren
	\item Prozess-Signalisierung und -kommunikation
	\item Faire Zuordnung von Hauptspeicher und anderen geteilten Ressourcen
	\item Ein-/Auslagerung von Prozessen bei vollem Speicher
	\item Prozesse und ihre Zustände anzeigen
\end{itemize}

\subsubsection{Aufbau}
\begin{center}
	\includegraphics[scale=0.25]{prozess-aufbau.png}
\end{center}

\subsubsection{Kernel und User Mode}
\begin{itemize}
	\item Ein Prozess hat mindestens zwei Ausführungsmodi:
		\begin{description}
			\item[User Mode] Es wird der normale Programmcode ausgeführt.
			\item[Kernl Mode] Es werden Systemaufrufe ausgeführt oder Ausnahmen behandelt.
		\end{description}
	\item Der Übergang erfolgt durch einen Systemaufruf durch das Programm, eine Ausnahmesituation oder durch asynchrone Events 
	\item Beide Modi haben separate Segmente und sind voneinander abgeschirmt.
\end{itemize}

\subsubsection{Zustände}
\begin{center}
	\includegraphics[scale=0.5]{process-states.png}
\end{center}

\subsection{Memory}
\subsubsection{Virtual Memory}
\begin{itemize}
	\item Erweiterung des Hauptspeichers pro System (mehr Prozesse im System als Speicher verfügbar), oder pro Prozess (einzelner Prozess grösser als verfu?gbarer Hauptspeicher).
	\item Systematische Abstraktion fu?r systemspezifische Overlay- Techniken.
	\item Organisation des Hauptspeichers in gleich grosse, einheitlich adressierbare Einheiten.
\end{itemize}

\subsubsection{Swapping}
\begin{center}
	\includegraphics[scale=0.3]{swapping.png}
\end{center}

\subsubsection{Paged Memory}
Design und Layout der Datenstrukturen fu?r die seiten-orientierte Speicherverwaltung variieren zwischen Unix- und Linux-Varianten und sind zudem von den Hardware- Eigenschaften abhängig. Linux verwendet zum Beuispiel eine 3-stufige Seitentabelle:
\begin{itemize}
	\item Page Directory pro Prozess und für den BS-Kern
	\item Page Mid-level Directory (für 64 bit CPU-Architekturen) Paged Memory II
	\item Page Table, enthält Seitenbeschreibungen und Verweise auf den physische Speicheror
\end{itemize}

\subsubsection{Fehlerzustände}
\begin{center}
	\includegraphics[scale=0.3]{memory-error-state.png}
\end{center}

\newpage
\section{System Call Schnittstelle}
\begin{center}
	\includegraphics[scale=0.5]{system-calls.png}
\end{center}
\subsection{Prozess-System}
\begin{description}
	\item[fork()] Erzeugung
	\item[exit()] Beendigung
	\item[exec()] Überlagerung des Prozesses
	\item[wait()] Warten auf Prozesstermination (Kindprozesse)
	\item[sleep()] Freiwilliges schlafen des Prozesses.
	\item[kill()] Senden eines Signals (32 verschiedene)
	\item[signal()] Signalbehandlung
\end{description}

\subsection{Datei-System}
\begin{description}
	\item[creat()] Anlegen einer Datei
	\item[mknod()] Anlegen eines Ordners
	\item[open()] Öffnen einer Datei
	\item[close()] Schliessen einer Datei
	\item[unlink()] Löschen einer Datei
	\item[read()] Lesen aus einer Datei
	\item[write()] Schreiben in eine Datei
	\item[lseek()] Vorwärts-/Rückwertsbewegung
	\item[ioctl()] Kontrollieren der Eigenschaften
	\item[dup()] Duplizieren eines Dateideskriptors
	\item[chown, chmod, umask] Zugriffsrechte
	\item[chdir()] Navigation im Dateisystem
\end{description}

\subsection{Directory Handling}
\begin{description}
	\item[opendir()] Öffnen eines Verzeichnises
	\item[readdir()] Lesen eines Verzeichnises
	\item[writedir()] Schreiben eines Verzeichnises
	\item[closedir()]  Schliessen eines Verzeichnises
\end{description}
		
\subsection{Speicherverwaltung}
\begin{description}
	\item[malloc()] Speicher allozieren
	\item[free()	] Speicher freigeben
\end{description}

\subsection{Weitere}
\begin{description}
	\item[pipe()] Basis-Interprozesskommunikation
	\item[socket()] Interprozesskommunikation lokal oder u?ber Netzwerke
\end{description}

\newpage
\section{Dateisystem}

\subsection{Übersicht}
\begin{center}
	\includegraphics[scale=0.5]{filesystem-overview.png}
\end{center}

\subsection{Relevante Dateisystem Algorithmen}
\subsubsection{Pfadnahme zu inode}
\textit{namei()} öffnet das aktuelle oder Root Verzeichnis . Navigiert rekursiv und basierend auf den Pfadkomponenten durch den Dateisystem- Baum bis ein Fehler auftritt oder die Datei gefunden wird. Umfasst eine Cache Struktur von kürzlich benutzten Namen und der zugehörigen inode-Nummer.
\subsubsection{Gemeinsame Nutzung von Dateien}
Zwei Prozesse können die selbe Datei für Lese- oder Schreibzugriff öffnen. Beide haben separate Lese-/Schreib-Indices und es gibt keine Konsistenzwahrung durch den Kernel, ausser für einzelne \textit{read()} und \textit{write()} Operationen, die atomar ausgeführt werden. Nach einem \textit{fork()} eines Prozesses mit offenen Dateien teilen sich beide Prozesse den Lese-/Schreib-Index in der Dateitabelle.
\subsubsection{Datei Locking}
Eine Schwachstelle in Unix. Einige Unix- Varianten und Linux erlauben das Locking von Dateien pro read/write-Operation auf einem inode mittels Semaphoren. Der POSIX Standard verlangt sogar das Locken von Teilen einer Datei, aber dies wurde nur selten implementiert. Die meisten Unix Varianten unterstützen advisory locks (flock) oder Lock Dateien, die andere Prozesse jedoch ggf. Ignorieren können.
\subsubsection{Mount / Unmount}
Ein Directory kann als mount point diesen - das Directory muss dafür nicht leer sein, aber die enthaltenen Dateien sind nicht sichtbar, solange das Verzeichnis als Mount Point aktiv ist. Eine Mount-Tabelle entha?lt alle aktuell gemounteten Dateisysteme. Der automounter-Prozess kann zudem Dateisysteme bei Bedarf mounten/unmounten.

\subsection{Allokation}
\subsubsection{inode}
Dateisystem feststellen, Superblock locken (Schlafen wenn besetzt), nächsten inode aus der free list holen - wenn Liste leer, auffüllen, wenn danach inode verfügbar return inode, sonst return.
\subsubsection{Datenblock}
Dateisystem feststellen, Superblock locken (Schlafen wenn besetzt), nächsten freien Datenblock aus der free list (meist Bitmap) holen, wenn kein Datenblock frei ist, Schlafen bis Datenblock verfügbar wird).

\subsection{Synchronisation von Zugriffen auf das Dateisystem}
Der Superblock jedes Dateisystems enthält Lock Bits, um Prozessen bei schreibendem Zugriff (inode oder Datenblock holen) atomaren Zugriff auf die Datenstrukturen im Superblock zu erlauben. Dennoch kann es zu race conditions kommen, da die Locks nur sehr kurzlebig sein dürfen (Performance!) der Prozess jederzeit preempted werden kann. Es gibt Replikate des Superblocks im Dateisystem, diese werde jedoch nicht aktualisiert.

\subsection{Geräte}
\subsubsection{Einbindung}
\begin{itemize}
	\item Zentrales Element: Gerätespezialdateien im /dev bzw. /devices Dateisystem als einheitliche Schnittstelle, Dateideskriptor im Prozess.
	\item Major / Minor Device Number zur Identifikation
	\item Zugriffsrechte auf die Gerätespezialdateien sind relevant
	\item Geräte in verschiedenen Betriebs-Modi: block- oder zeichenweiser Zugriff
	\item Echte Geräte und Pseudo-Geräte (z.B. virtuelle Terminals, Netzwerkprotokolle oder /dev/null)
\end{itemize}
\subsubsection{Gerätetreiber}
Gerätetreiber sind die einzige Schnittstelle, über die ein Prozess mit Geräten kommunizieren kann. Sie sind Teil des kernel-Codes des Systems, und werden entweder statisch beim Systemstart oder zur Laufzeit (in Linux: insmod/rmmod) geladen.
In Unix sind Gerätetreiber Teil jedes Prozesses (über den Kernel-Code) - in anderen Betriebssystemen sind sie nur speziellen Kommunikationsprozessen zugänglich über die die anderen Prozesse dann mit Geräten kommunizieren müssen.
\subsubsection{Gerätespezialdateien}
\begin{center}
	\includegraphics[scale=0.5]{special-files-devices.png}
\end{center}
% Inhalt Ende

\subsection{Beispiele}
\subsubsection{Verzeichnismanipulation}
\lstinputlisting[language=java,caption=Verzeichnismanipulation,style=JavaStyle]{dir_handling.c}
\newpage
\subsubsection{Dateimanipulation}
\lstinputlisting[language=java,caption=Dateimanipulation,style=JavaStyle]{file_handling.c}

\newpage
\subsubsection{Dateisystem-Baum}
\lstinputlisting[language=java,caption=Dateisystem-Baum,style=JavaStyle]{fs_handling.c}

\end{document}